name: Bundle Size Check

on:
  pull_request:
    branches: [ main, master ]

jobs:
  size-check:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout PR
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build PR
      run: npm run build

    - name: Get PR bundle size
      id: pr-size
      run: |
        PR_SIZE=$(du -sb dist | cut -f1)
        PR_SIZE_MB=$(echo "scale=2; $PR_SIZE / 1024 / 1024" | bc)
        echo "size=$PR_SIZE" >> $GITHUB_OUTPUT
        echo "size_mb=$PR_SIZE_MB" >> $GITHUB_OUTPUT

    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.base_ref }}

    - name: Build base
      run: |
        npm ci
        npm run build

    - name: Get base bundle size
      id: base-size
      run: |
        BASE_SIZE=$(du -sb dist | cut -f1)
        BASE_SIZE_MB=$(echo "scale=2; $BASE_SIZE / 1024 / 1024" | bc)
        echo "size=$BASE_SIZE" >> $GITHUB_OUTPUT
        echo "size_mb=$BASE_SIZE_MB" >> $GITHUB_OUTPUT

    - name: Compare sizes
      uses: actions/github-script@v7
      with:
        script: |
          const prSize = parseInt('${{ steps.pr-size.outputs.size }}');
          const baseSize = parseInt('${{ steps.base-size.outputs.size }}');
          const prSizeMB = '${{ steps.pr-size.outputs.size_mb }}';
          const baseSizeMB = '${{ steps.base-size.outputs.size_mb }}';
          
          const diff = prSize - baseSize;
          const diffPercent = ((diff / baseSize) * 100).toFixed(2);
          const diffMB = (diff / 1024 / 1024).toFixed(2);
          
          let emoji = 'ðŸ“Š';
          let status = 'No significant change';
          
          if (Math.abs(diff) < 10240) { // Less than 10KB
            emoji = 'âœ…';
            status = 'Minimal impact';
          } else if (diff > 0) {
            emoji = 'ðŸ“ˆ';
            status = 'Size increased';
          } else {
            emoji = 'ðŸ“‰';
            status = 'Size decreased';
          }
          
          const comment = `## ${emoji} Bundle Size Report
          
          **Status:** ${status}
          
          | Branch | Size |
          |--------|------|
          | Base (\`${context.payload.pull_request.base.ref}\`) | ${baseSizeMB} MB |
          | PR (\`${context.payload.pull_request.head.ref}\`) | ${prSizeMB} MB |
          | **Difference** | **${diff > 0 ? '+' : ''}${diffMB} MB (${diff > 0 ? '+' : ''}${diffPercent}%)** |
          
          ---
          <sub>This report shows the impact of your changes on the final bundle size.</sub>`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

